local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Terrain = workspace:WaitForChild("Terrain")
local localPlayer = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- Colors :3
local COLORS = {
	Nightvision = Color3.fromRGB(157, 0, 157),
	Bandana = Color3.fromRGB(85, 255, 255),
}

local HIGHLIGHT_FILL_COLORS = {
	Nightvision = Color3.fromRGB(255, 0, 255),
	Bandana = Color3.fromRGB(85, 255, 255),
}

local function createBillboardGui(text, color)
	local billboard = Instance.new("BillboardGui")
	billboard.Name = "ESP_UI"
	billboard.Size = UDim2.new(0, 100, 0, 30)
	billboard.AlwaysOnTop = true
	billboard.StudsOffset = Vector3.new(0, 2.5, 0)

	local label = Instance.new("TextLabel", billboard)
	label.Size = UDim2.new(1, 0, 1, 0)
	label.BackgroundTransparency = 1
	label.Text = text
	label.TextColor3 = color
	label.TextStrokeTransparency = 0
	label.Font = Enum.Font.SourceSansBold
	label.TextScaled = true

	return billboard
end

local function createHighlight(targetPart, color)
	if not targetPart then return nil end
	local highlight = Instance.new("Highlight")
	highlight.Name = "ESP_Highlight"
	highlight.Adornee = targetPart
	highlight.FillColor = color
	highlight.FillTransparency = 0.5
	highlight.OutlineColor = Color3.new(1, 1, 1)
	highlight.OutlineTransparency = 0
	highlight.Parent = targetPart
	return highlight
end

local function createBeam(fromPart, toPart, color)
	if not fromPart or not toPart then return nil end

	-- Clean existing beams named "ESP_Beam" to avoid duplicates
	for _, child in pairs(fromPart:GetChildren()) do
		if child:IsA("Beam") and child.Name == "ESP_Beam" then
			child:Destroy()
		end
	end

	-- Create attachments if missing
	local att0 = fromPart:FindFirstChild("ESP_Attachment") or Instance.new("Attachment", fromPart)
	att0.Name = "ESP_Attachment"
	att0.Position = Vector3.new(0, fromPart.Size.Y / 2, 0)

	local att1 = toPart:FindFirstChild("ESP_Attachment") or Instance.new("Attachment", toPart)
	att1.Name = "ESP_Attachment"
	att1.Position = Vector3.new(0, toPart.Size.Y / 2, 0)

	local beam = Instance.new("Beam")
	beam.Name = "ESP_Beam"
	beam.Attachment0 = att0
	beam.Attachment1 = att1
	beam.FaceCamera = true
	beam.Width0 = 0.1
	beam.Width1 = 0.1
	beam.Color = ColorSequence.new(color)
	beam.Transparency = NumberSequence.new(0.5)
	beam.Parent = att0

	return beam
end

local trackedModels = {}

local function clearESP(model)
	if trackedModels[model] then
		local data = trackedModels[model]

		if data.BillboardGui and data.BillboardGui.Parent then
			data.BillboardGui:Destroy()
		end
		if data.Highlight and data.Highlight.Parent then
			data.Highlight:Destroy()
		end
		if data.Beam then
			data.Beam:Destroy()
		end
		trackedModels[model] = nil
	end
end

local function applyESP(model)
	if not model:IsA("Model") then return end
	if trackedModels[model] then return end -- Already applied

	local modelName = model.Name
	local hitbox = model:FindFirstChild("Hitbox")
	local parts = model:FindFirstChild("Parts")

	if not hitbox or not hitbox:IsA("BasePart") then
		return
	end

	if not parts or not parts:IsA("Model") then
		return
	end

	local targetMeshPart = nil
	local text = ""
	local textColor = nil
	local highlightColor = nil

	if modelName == "Nightvision" then
		targetMeshPart = parts:FindFirstChild("Goggles")
		text = "Goggles"
		textColor = COLORS.Nightvision
		highlightColor = HIGHLIGHT_FILL_COLORS.Nightvision
	elseif modelName == "Bandana" then
		targetMeshPart = parts:FindFirstChild("Bandana")
		text = "Bandana"
		textColor = COLORS.Bandana
		highlightColor = HIGHLIGHT_FILL_COLORS.Bandana
	else
		return -- Ignore other models
	end

	if not targetMeshPart or not targetMeshPart:IsA("BasePart") then
		return
	end

	-- BillboardGui
	local billboard = createBillboardGui(text, textColor)
	billboard.Adornee = hitbox
	billboard.Parent = hitbox

	-- Highlight
	local highlight = createHighlight(targetMeshPart, highlightColor)

	-- Beam (tracer)
	local beam = createBeam(localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart"), hitbox, highlightColor)

	trackedModels[model] = {
		BillboardGui = billboard,
		Highlight = highlight,
		Beam = beam
	}
end

local function scanTerrain()
	for _, model in pairs(Terrain:GetChildren()) do
		if model.Name == "Nightvision" or model.Name == "Bandana" then
			if not trackedModels[model] then
				applyESP(model)
			end
		else
			-- Clean any tracked models no longer present or changed
			if trackedModels[model] then
				clearESP(model)
			end
		end
	end

	-- Clean up tracked models no longer in Terrain
	for model, _ in pairs(trackedModels) do
		if not Terrain:FindFirstChild(model.Name) then
			clearESP(model)
		end
	end
end

local function onCharacterAdded(char)
	wait(1) -- let the char fully load
	for model, data in pairs(trackedModels) do
		if data.Beam then data.Beam:Destroy() end
		data.Beam = createBeam(char:WaitForChild("HumanoidRootPart"), model:FindFirstChild("Hitbox"), HIGHLIGHT_FILL_COLORS[model.Name])
	end
end

localPlayer.CharacterAdded:Connect(onCharacterAdded)
if localPlayer.Character then
	onCharacterAdded(localPlayer.Character)
end

-- Run every 5 seconds
while true do
	scanTerrain()
	wait(5)
end
